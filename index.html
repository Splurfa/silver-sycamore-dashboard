<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silver Sycamore Pipeline</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --bg: #FFFFFF;
            --border: #E1E4E8;
            --text-primary: #24292E;
            --text-secondary: #586069;
            --text-muted: #6A737D;
            --hover: #F6F8FA;
            --link: #0366D6;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Navigation */
        .nav {
            border-bottom: 1px solid var(--border);
            margin-bottom: 24px;
            padding-bottom: 16px;
        }

        .nav-inner {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .nav-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-right: auto;
        }

        .nav-item {
            font-size: 14px;
            color: var(--text-secondary);
            text-decoration: none;
            padding: 8px 0;
            border-bottom: 2px solid transparent;
            cursor: pointer;
        }

        .nav-item:hover {
            color: var(--text-primary);
        }

        .nav-item.active {
            color: var(--text-primary);
            border-bottom-color: var(--link);
        }

        /* Back button */
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            color: var(--text-secondary);
            text-decoration: none;
            margin-bottom: 16px;
            cursor: pointer;
        }

        .back-btn:hover {
            color: var(--link);
        }

        /* Phase banner */
        .phase-banner {
            background: var(--hover);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 24px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .phase-banner strong {
            color: var(--text-primary);
        }

        /* Category sections */
        .category {
            margin-bottom: 32px;
        }

        .category-header {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        /* Table styles */
        .matrix-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .matrix-table th {
            text-align: left;
            padding: 10px 12px;
            background: var(--hover);
            border: 1px solid var(--border);
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .matrix-table td {
            padding: 10px 12px;
            border: 1px solid var(--border);
            vertical-align: top;
        }

        .matrix-table tr:hover td {
            background: var(--hover);
        }

        .matrix-table .initiative-name {
            font-weight: 500;
            color: var(--link);
            cursor: pointer;
            white-space: nowrap;
        }

        .matrix-table .initiative-name:hover {
            text-decoration: underline;
        }

        .matrix-table .cell-content {
            color: var(--text-secondary);
            font-size: 12px;
        }

        /* Status badges */
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            text-transform: capitalize;
        }

        .status-badge.in-progress { background: #FFF3CD; color: #856404; }
        .status-badge.building { background: #D1ECF1; color: #0C5460; }
        .status-badge.piloting { background: #D4EDDA; color: #155724; }
        .status-badge.done { background: #C3E6CB; color: #155724; }
        .status-badge.discovery { background: #E2D5F1; color: #5A3D7A; }
        .status-badge.pending { background: #F8D7DA; color: #721C24; }
        .status-badge.active { background: #D4EDDA; color: #155724; }
        .status-badge.closed { background: #E9ECEF; color: #495057; }

        /* Detail view */
        .detail-header {
            margin-bottom: 24px;
        }

        .detail-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .detail-meta {
            display: flex;
            gap: 16px;
            align-items: center;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .detail-meta .category-badge {
            background: var(--hover);
            padding: 4px 10px;
            border-radius: 4px;
            border: 1px solid var(--border);
        }

        /* MOVE summary card */
        .move-card {
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 24px;
            overflow: hidden;
        }

        .move-card-header {
            background: var(--hover);
            padding: 12px 16px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
        }

        .move-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
        }

        @media (max-width: 768px) {
            .move-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .move-cell {
            padding: 16px;
            border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
        }

        .move-cell:nth-child(4n) {
            border-right: none;
        }

        .move-cell:nth-last-child(-n+4) {
            border-bottom: none;
        }

        @media (max-width: 768px) {
            .move-cell:nth-child(2n) {
                border-right: none;
            }
            .move-cell:nth-last-child(-n+2) {
                border-bottom: none;
            }
        }

        .move-cell-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .move-cell-content {
            font-size: 13px;
            color: var(--text-primary);
        }

        /* Sub-projects table */
        .subprojects {
            margin-bottom: 24px;
        }

        .subprojects-header {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        /* Notes section */
        .notes-section {
            border-top: 1px solid var(--border);
            padding-top: 24px;
        }

        .notes-section h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .notes-content {
            font-size: 14px;
            line-height: 1.6;
        }

        .notes-content h1, .notes-content h2, .notes-content h3, .notes-content h4 {
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .notes-content h3 { font-size: 15px; }
        .notes-content h4 { font-size: 14px; color: var(--text-secondary); }

        .notes-content p {
            margin-bottom: 12px;
        }

        .notes-content ul, .notes-content ol {
            margin-left: 20px;
            margin-bottom: 12px;
        }

        .notes-content li {
            margin-bottom: 4px;
        }

        .notes-content strong {
            font-weight: 600;
        }

        .notes-content a {
            color: var(--link);
        }

        /* Sessions list */
        .sessions-list {
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }

        .session-row {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }

        .session-row:last-child {
            border-bottom: none;
        }

        .session-row:hover {
            background: var(--hover);
        }

        .session-date {
            font-weight: 500;
            color: var(--link);
            width: 120px;
        }

        .session-status {
            width: 80px;
        }

        .session-summary {
            flex: 1;
            color: var(--text-secondary);
            font-size: 13px;
        }

        /* Session detail */
        .session-content {
            font-size: 14px;
            line-height: 1.6;
        }

        .session-content h1 { font-size: 20px; margin-bottom: 16px; }
        .session-content h2 { font-size: 16px; margin-top: 24px; margin-bottom: 12px; border-bottom: 1px solid var(--border); padding-bottom: 8px; }
        .session-content h3 { font-size: 14px; margin-top: 16px; margin-bottom: 8px; }

        .session-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 12px 0;
            font-size: 13px;
        }

        .session-content th, .session-content td {
            padding: 8px 12px;
            border: 1px solid var(--border);
            text-align: left;
        }

        .session-content th {
            background: var(--hover);
            font-weight: 600;
        }

        .session-content ul, .session-content ol {
            margin-left: 20px;
            margin-bottom: 12px;
        }

        .session-content a {
            color: var(--link);
        }

        /* Loading state */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
            font-size: 14px;
        }

        /* Value delivered section */
        .value-section {
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }

        .value-header {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-secondary);
        }

        /* Meetings section */
        .meetings-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }

        .meetings-section h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .meeting-item {
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .meeting-item:hover {
            background: var(--hover);
        }

        .meeting-title {
            font-weight: 500;
            color: var(--link);
        }

        /* Hide views */
        .view { display: none; }
        .view.active { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <nav class="nav">
            <div class="nav-inner">
                <div class="nav-title">Silver Sycamore</div>
                <a class="nav-item active" data-page="pipeline" onclick="showPipeline()">Pipeline</a>
                <a class="nav-item" data-page="sessions" onclick="showSessions()">Sessions</a>
            </div>
        </nav>

        <main id="content">
            <div class="loading">Loading...</div>
        </main>
    </div>

    <script>
        // State
        let pipelineData = null;
        let currentView = 'pipeline';

        // Content base URL
        const CONTENT_BASE = './content';

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadPipeline();
            showPipeline();
        });

        // Load and parse pipeline.md
        async function loadPipeline() {
            try {
                const response = await fetch(`${CONTENT_BASE}/artifacts/pipeline.md`);
                if (!response.ok) throw new Error('Pipeline not found');
                const text = await response.text();
                pipelineData = parsePipeline(text);
            } catch (error) {
                console.error('Error loading pipeline:', error);
                pipelineData = { phase: 'Unable to load', categories: [], sessions: [], valueDelivered: [] };
            }
        }

        // Parse pipeline markdown into structured data
        function parsePipeline(text) {
            const lines = text.split('\n');
            const data = {
                phase: '',
                categories: [],
                sessions: [],
                valueDelivered: []
            };

            let currentSection = null;
            let currentCategory = null;
            let inTable = false;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();

                // Phase
                if (line.startsWith('## Phase')) {
                    currentSection = 'phase';
                    continue;
                }

                // Category headers
                if (line.startsWith('## Marketing & Digital') ||
                    line.startsWith('## Products & Revenue') ||
                    line.startsWith('## Operations & Tools') ||
                    line.startsWith('## Discovery')) {
                    currentSection = 'category';
                    currentCategory = { name: line.replace('## ', ''), initiatives: [] };
                    data.categories.push(currentCategory);
                    inTable = false;
                    continue;
                }

                // Value Delivered
                if (line.startsWith('## Value Delivered')) {
                    currentSection = 'value';
                    currentCategory = null;
                    inTable = false;
                    continue;
                }

                // Sessions
                if (line.startsWith('## Sessions')) {
                    currentSection = 'sessions';
                    currentCategory = null;
                    inTable = false;
                    continue;
                }

                // Skip other sections
                if (line.startsWith('## ')) {
                    currentSection = 'other';
                    currentCategory = null;
                    inTable = false;
                    continue;
                }

                // Parse phase content
                if (currentSection === 'phase' && line && !line.startsWith('---')) {
                    data.phase = line;
                    currentSection = null;
                }

                // Parse tables
                if (line.startsWith('|')) {
                    const cells = line.split('|').map(c => c.trim()).filter(c => c);

                    // Header row
                    if (!inTable) {
                        inTable = true;
                        continue;
                    }

                    // Separator row
                    if (cells.every(c => c.match(/^[-:]+$/))) {
                        continue;
                    }

                    // Data row for categories
                    if (currentSection === 'category' && currentCategory && cells.length >= 5) {
                        const initiative = parseInitiativeRow(cells);
                        currentCategory.initiatives.push(initiative);
                    }

                    // Data row for sessions
                    if (currentSection === 'sessions' && cells.length >= 3) {
                        const session = parseSessionRow(cells);
                        data.sessions.push(session);
                    }

                    // Data row for value
                    if (currentSection === 'value' && cells.length >= 3) {
                        data.valueDelivered.push({
                            date: cells[0],
                            what: cells[1],
                            impact: cells[2]
                        });
                    }
                } else {
                    inTable = false;
                }
            }

            return data;
        }

        // Parse initiative row
        function parseInitiativeRow(cells) {
            const linkMatch = cells[0].match(/\[([^\]]+)\]\(([^)]+)\)/);
            return {
                name: linkMatch ? linkMatch[1] : cells[0],
                path: linkMatch ? linkMatch[2] : null,
                map: cells[1] || 'TBD',
                outcome: cells[2] || 'TBD',
                verify: cells[3] || 'TBD',
                exchange: cells[4] || 'TBD',
                status: cells[5] || 'Unknown'
            };
        }

        // Parse session row
        function parseSessionRow(cells) {
            const linkMatch = cells[0].match(/\[([^\]]+)\]\(([^)]+)\)/);
            return {
                date: linkMatch ? linkMatch[1] : cells[0],
                path: linkMatch ? linkMatch[2] : null,
                status: cells[1] || '',
                summary: cells[2] || ''
            };
        }

        // Status badge class
        function getStatusClass(status) {
            const s = status.toLowerCase().replace(/\s+/g, '-');
            if (s.includes('progress')) return 'in-progress';
            if (s.includes('building')) return 'building';
            if (s.includes('piloting')) return 'piloting';
            if (s.includes('done')) return 'done';
            if (s.includes('discovery')) return 'discovery';
            if (s.includes('pending')) return 'pending';
            if (s.includes('active')) return 'active';
            if (s.includes('closed')) return 'closed';
            return '';
        }

        // Show pipeline view
        function showPipeline() {
            currentView = 'pipeline';
            updateNav('pipeline');

            if (!pipelineData) {
                document.getElementById('content').innerHTML = '<div class="loading">Loading...</div>';
                return;
            }

            let html = `
                <div class="phase-banner">
                    <strong>Phase:</strong> ${escapeHtml(pipelineData.phase)}
                </div>
            `;

            // Categories
            for (const category of pipelineData.categories) {
                html += `
                    <div class="category">
                        <div class="category-header">${escapeHtml(category.name)}</div>
                        <table class="matrix-table">
                            <thead>
                                <tr>
                                    <th style="width: 180px;">Initiative</th>
                                    <th>MAP</th>
                                    <th>OUTCOME</th>
                                    <th>VERIFY</th>
                                    <th>EXCHANGE</th>
                                    <th style="width: 100px;">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                for (const init of category.initiatives) {
                    const onclick = init.path ? `onclick="showInitiative('${escapeHtml(init.path)}')"` : '';
                    html += `
                        <tr>
                            <td class="initiative-name" ${onclick}>${escapeHtml(init.name)}</td>
                            <td class="cell-content">${escapeHtml(init.map)}</td>
                            <td class="cell-content">${escapeHtml(init.outcome)}</td>
                            <td class="cell-content">${escapeHtml(init.verify)}</td>
                            <td class="cell-content">${escapeHtml(init.exchange)}</td>
                            <td><span class="status-badge ${getStatusClass(init.status)}">${escapeHtml(init.status)}</span></td>
                        </tr>
                    `;
                }

                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // Value delivered
            if (pipelineData.valueDelivered.length > 0) {
                html += `
                    <div class="value-section">
                        <div class="value-header">Value Delivered</div>
                        <table class="matrix-table">
                            <thead>
                                <tr>
                                    <th style="width: 100px;">Date</th>
                                    <th>What</th>
                                    <th>Impact</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                for (const value of pipelineData.valueDelivered) {
                    html += `
                        <tr>
                            <td>${escapeHtml(value.date)}</td>
                            <td>${escapeHtml(value.what)}</td>
                            <td class="cell-content">${escapeHtml(value.impact)}</td>
                        </tr>
                    `;
                }

                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }

            document.getElementById('content').innerHTML = html;
        }

        // Show sessions view
        function showSessions() {
            currentView = 'sessions';
            updateNav('sessions');

            if (!pipelineData || pipelineData.sessions.length === 0) {
                document.getElementById('content').innerHTML = '<div class="empty-state">No sessions found</div>';
                return;
            }

            let html = '<div class="sessions-list">';

            for (const session of pipelineData.sessions) {
                const onclick = session.path ? `onclick="showSession('${escapeHtml(session.path)}')"` : '';
                html += `
                    <div class="session-row" ${onclick}>
                        <div class="session-date">${escapeHtml(session.date)}</div>
                        <div class="session-status">
                            <span class="status-badge ${getStatusClass(session.status)}">${escapeHtml(session.status)}</span>
                        </div>
                        <div class="session-summary">${escapeHtml(session.summary)}</div>
                    </div>
                `;
            }

            html += '</div>';
            document.getElementById('content').innerHTML = html;
        }

        // Show initiative detail
        async function showInitiative(path) {
            currentView = 'initiative';
            updateNav(null);

            document.getElementById('content').innerHTML = '<div class="loading">Loading initiative...</div>';

            try {
                // Normalize path
                let contentPath = path;
                if (path.startsWith('initiatives/')) {
                    contentPath = `${CONTENT_BASE}/artifacts/${path}/index.md`;
                } else if (!path.includes('/')) {
                    contentPath = `${CONTENT_BASE}/artifacts/initiatives/${path}/index.md`;
                } else {
                    contentPath = `${CONTENT_BASE}/artifacts/${path}/index.md`;
                }

                const response = await fetch(contentPath);
                if (!response.ok) throw new Error('Initiative not found');
                const text = await response.text();

                renderInitiativeDetail(text, path);
            } catch (error) {
                console.error('Error loading initiative:', error);
                document.getElementById('content').innerHTML = `
                    <a class="back-btn" onclick="showPipeline()">← Back to Pipeline</a>
                    <div class="empty-state">Unable to load initiative details. ${escapeHtml(error.message)}</div>
                `;
            }
        }

        // Render initiative detail
        function renderInitiativeDetail(markdown, path) {
            const data = parseInitiativeMarkdown(markdown);

            let html = `
                <a class="back-btn" onclick="showPipeline()">← Back to Pipeline</a>

                <div class="detail-header">
                    <h1 class="detail-title">${escapeHtml(data.title)}</h1>
                    <div class="detail-meta">
                        <span class="category-badge">${escapeHtml(data.category || 'Uncategorized')}</span>
                        <span class="status-badge ${getStatusClass(data.status)}">${escapeHtml(data.status)}</span>
                    </div>
                </div>

                <div class="move-card">
                    <div class="move-card-header">MOVE Summary</div>
                    <div class="move-grid">
                        <div class="move-cell">
                            <div class="move-cell-label">MAP</div>
                            <div class="move-cell-content">${escapeHtml(data.move.map || 'TBD')}</div>
                        </div>
                        <div class="move-cell">
                            <div class="move-cell-label">OUTCOME</div>
                            <div class="move-cell-content">${escapeHtml(data.move.outcome || 'TBD')}</div>
                        </div>
                        <div class="move-cell">
                            <div class="move-cell-label">VERIFY</div>
                            <div class="move-cell-content">${escapeHtml(data.move.verify || 'TBD')}</div>
                        </div>
                        <div class="move-cell">
                            <div class="move-cell-label">EXCHANGE</div>
                            <div class="move-cell-content">${escapeHtml(data.move.exchange || 'TBD')}</div>
                        </div>
                    </div>
                </div>
            `;

            // Sub-projects
            if (data.subprojects.length > 0) {
                html += `
                    <div class="subprojects">
                        <div class="subprojects-header">Sub-Projects</div>
                        <table class="matrix-table">
                            <thead>
                                <tr>
                                    <th>Task</th>
                                    <th>MAP</th>
                                    <th>OUTCOME</th>
                                    <th>VERIFY</th>
                                    <th>EXCHANGE</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                for (const sub of data.subprojects) {
                    html += `
                        <tr>
                            <td class="initiative-name">${escapeHtml(sub.name)}</td>
                            <td class="cell-content">${escapeHtml(sub.map)}</td>
                            <td class="cell-content">${escapeHtml(sub.outcome)}</td>
                            <td class="cell-content">${escapeHtml(sub.verify)}</td>
                            <td class="cell-content">${escapeHtml(sub.exchange)}</td>
                            <td><span class="status-badge ${getStatusClass(sub.status)}">${escapeHtml(sub.status)}</span></td>
                        </tr>
                    `;
                }

                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // Notes
            if (data.notes) {
                html += `
                    <div class="notes-section">
                        <div class="notes-content">${marked.parse(data.notes)}</div>
                    </div>
                `;
            }

            document.getElementById('content').innerHTML = html;
        }

        // Parse initiative markdown
        function parseInitiativeMarkdown(text) {
            const lines = text.split('\n');
            const data = {
                title: '',
                category: '',
                status: '',
                move: { map: '', outcome: '', verify: '', exchange: '' },
                subprojects: [],
                notes: ''
            };

            let currentSection = null;
            let notesStart = -1;
            let inMoveTable = false;
            let inSubTable = false;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();

                // Title
                if (line.startsWith('# ') && !data.title) {
                    data.title = line.replace('# ', '');
                    continue;
                }

                // Section headers
                if (line === '## Category') { currentSection = 'category'; continue; }
                if (line === '## Status') { currentSection = 'status'; continue; }
                if (line === '## MOVE') { currentSection = 'move'; inMoveTable = false; continue; }
                if (line === '## Sub-Projects') { currentSection = 'subprojects'; inSubTable = false; continue; }
                if (line === '## Notes') { currentSection = 'notes'; notesStart = i + 1; continue; }
                if (line === '## Related') { currentSection = 'related'; continue; }

                // Parse category
                if (currentSection === 'category' && line && !line.startsWith('#')) {
                    data.category = line;
                    currentSection = null;
                }

                // Parse status
                if (currentSection === 'status' && line && !line.startsWith('#')) {
                    data.status = line;
                    currentSection = null;
                }

                // Parse MOVE table
                if (currentSection === 'move' && line.startsWith('|')) {
                    const cells = line.split('|').map(c => c.trim()).filter(c => c);

                    if (!inMoveTable) {
                        inMoveTable = true;
                        continue;
                    }

                    if (cells.every(c => c.match(/^[-:]+$/))) continue;

                    if (cells.length >= 4) {
                        data.move.map = cells[0];
                        data.move.outcome = cells[1];
                        data.move.verify = cells[2];
                        data.move.exchange = cells[3];
                    }
                }

                // Parse sub-projects table
                if (currentSection === 'subprojects' && line.startsWith('|')) {
                    const cells = line.split('|').map(c => c.trim()).filter(c => c);

                    if (!inSubTable) {
                        inSubTable = true;
                        continue;
                    }

                    if (cells.every(c => c.match(/^[-:]+$/))) continue;

                    if (cells.length >= 6) {
                        const linkMatch = cells[0].match(/\[([^\]]+)\]/);
                        data.subprojects.push({
                            name: linkMatch ? linkMatch[1] : cells[0],
                            map: cells[1],
                            outcome: cells[2],
                            verify: cells[3],
                            exchange: cells[4],
                            status: cells[5]
                        });
                    }
                }
            }

            // Extract notes
            if (notesStart > 0) {
                const notesLines = [];
                for (let i = notesStart; i < lines.length; i++) {
                    if (lines[i].trim() === '## Related') break;
                    notesLines.push(lines[i]);
                }
                data.notes = notesLines.join('\n').trim();
            }

            return data;
        }

        // Show session detail
        async function showSession(path) {
            currentView = 'session';
            updateNav('sessions');

            document.getElementById('content').innerHTML = '<div class="loading">Loading session...</div>';

            try {
                // Normalize path
                let basePath = path;
                if (path.startsWith('../sessions/')) {
                    basePath = path.replace('../sessions/', '');
                } else if (path.startsWith('sessions/')) {
                    basePath = path.replace('sessions/', '');
                }

                // Clean trailing slash
                basePath = basePath.replace(/\/$/, '');

                // Load session.md
                const sessionFile = `${CONTENT_BASE}/sessions/${basePath}/session.md`;
                const response = await fetch(sessionFile);

                if (!response.ok) throw new Error('Session not found');
                const text = await response.text();

                // Try to load meetings
                const meetings = await loadMeetings(basePath);

                renderSessionDetail(text, meetings, basePath);
            } catch (error) {
                console.error('Error loading session:', error);
                document.getElementById('content').innerHTML = `
                    <a class="back-btn" onclick="showSessions()">← Back to Sessions</a>
                    <div class="empty-state">Unable to load session. ${escapeHtml(error.message)}</div>
                `;
            }
        }

        // Load meetings for a session
        async function loadMeetings(sessionPath) {
            const meetings = [];

            // Try common meeting file patterns
            const possibleMeetings = [
                'aubrey-marketing-director.md',
                'meeting-notes.md'
            ];

            for (const filename of possibleMeetings) {
                try {
                    const response = await fetch(`${CONTENT_BASE}/sessions/${sessionPath}/meetings/${filename}`);
                    if (response.ok) {
                        const text = await response.text();
                        const titleMatch = text.match(/^#\s+(.+)/m);
                        meetings.push({
                            filename: filename,
                            title: titleMatch ? titleMatch[1] : filename.replace('.md', ''),
                            path: `${sessionPath}/meetings/${filename}`
                        });
                    }
                } catch (e) {}
            }

            return meetings;
        }

        // Render session detail
        function renderSessionDetail(markdown, meetings, sessionPath) {
            let html = `
                <a class="back-btn" onclick="showSessions()">← Back to Sessions</a>
                <div class="session-content">
                    ${marked.parse(markdown)}
                </div>
            `;

            // Meetings section
            if (meetings.length > 0) {
                html += `
                    <div class="meetings-section">
                        <h3>Meetings</h3>
                `;

                for (const meeting of meetings) {
                    html += `
                        <div class="meeting-item" onclick="showMeeting('${escapeHtml(meeting.path)}')">
                            <div class="meeting-title">${escapeHtml(meeting.title)}</div>
                        </div>
                    `;
                }

                html += '</div>';
            }

            document.getElementById('content').innerHTML = html;
        }

        // Show meeting detail
        async function showMeeting(path) {
            document.getElementById('content').innerHTML = '<div class="loading">Loading meeting...</div>';

            try {
                const response = await fetch(`${CONTENT_BASE}/sessions/${path}`);
                if (!response.ok) throw new Error('Meeting not found');
                const text = await response.text();

                const sessionPath = path.split('/meetings/')[0];

                let html = `
                    <a class="back-btn" onclick="showSession('${escapeHtml(sessionPath)}')">← Back to Session</a>
                    <div class="session-content">
                        ${marked.parse(text)}
                    </div>
                `;

                document.getElementById('content').innerHTML = html;
            } catch (error) {
                console.error('Error loading meeting:', error);
                document.getElementById('content').innerHTML = `
                    <a class="back-btn" onclick="showSessions()">← Back to Sessions</a>
                    <div class="empty-state">Unable to load meeting. ${escapeHtml(error.message)}</div>
                `;
            }
        }

        // Update nav active state
        function updateNav(page) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.page === page);
            });
        }

        // Escape HTML
        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
    </script>
</body>
</html>
